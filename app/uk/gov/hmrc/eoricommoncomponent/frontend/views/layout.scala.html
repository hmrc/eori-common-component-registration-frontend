@*
* Copyright 2021 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@

@import uk.gov.hmrc.eoricommoncomponent.frontend.config.AppConfig
@import uk.gov.hmrc.eoricommoncomponent.frontend.services.countries._
@import uk.gov.hmrc.eoricommoncomponent.frontend.views.ServiceName._
@import uk.gov.hmrc.hmrcfrontend.views.html.components.HmrcReportTechnicalIssue
@import uk.gov.hmrc.hmrcfrontend.views.html.components.HmrcTimeoutDialog
@import uk.gov.hmrc.hmrcfrontend.views.Aliases.TimeoutDialog
@import uk.gov.hmrc.hmrcfrontend.views.html.helpers.HmrcTrackingConsentSnippet
@import uk.gov.hmrc.hmrcfrontend.views.config.StandardBetaBanner
@import uk.gov.hmrc.hmrcfrontend.views.html.helpers.HmrcLayout
@import views.html.helper.CSPNonce

@this(hmrcLayout: HmrcLayout, standardBetaBanner: StandardBetaBanner, trackingConsentSnippet: HmrcTrackingConsentSnippet, appConfig: AppConfig, reportAProblemLink: HmrcReportTechnicalIssue, hmrcTimeoutDialog: HmrcTimeoutDialog)

@(  title: String,
    countriesInCountryPicker: CountriesInCountryPicker = NoCountriesInCountryPicker,
    form: Option[Form[_]] = None,
    suppressTelephoneNumberDetection: Boolean = true
)(content: Html)(implicit messages: Messages, request: Request[_])

@isLoggedIn = @{!request.session.isEmpty && request.session.get("authToken").isDefined}

@titleWithEnding = @{
    title + " - " + messages("cds.banner.registration") + " - " + messages("cds.end-of-title")
}

@titleErr = @{
    form match {
        case Some(f) if f.errors.nonEmpty => s"%s: %s".format(messages("cds.error.page-title"), titleWithEnding)
        case _ => titleWithEnding
    }
}

@signOutUrl = @{
    s"/customs-registration-services/${service.code}/register/sign-out"
}

@keepAliveUrl=  @{
    s"/customs-registration-services/${service.code}/register/keep-alive"
}

@theHead = {
    @if(suppressTelephoneNumberDetection) {
        <meta name="format-detection" content="telephone=no" />
    }
    <!-- Tracking Consent Snippet -->
    @trackingConsentSnippet()
    <!-- End Tracking Consent Snippet -->

    @partials.countrypickerscript(countriesInCountryPicker)

    @if(isLoggedIn){
        @hmrcTimeoutDialog(TimeoutDialog(
            title = Some(messages("cds.timeout.message")),
            timeout = Some(1200),
            countdown = Some(300),
            keepAliveUrl = Some(keepAliveUrl),
            signOutUrl = Some(signOutUrl),
            keepAliveButtonText = Some(messages("cds.timeout.keep-alive-button")),
            signOutButtonText = Some(messages("cds.timeout.sign-out-button"))
        ))
    }
}

@mainContent = {
    @content
}

@bodyEndBlockWrapper = {
    @if(countriesInCountryPicker != NoCountriesInCountryPicker) {
        <script type="text/javascript">
                var countryPickerInputElements = document.getElementsByClassName('autocomplete__input');
                var form = document.getElementsByTagName('form')[0];

                form.addEventListener('submit', function () {
                    for (var i = 0; i < countryPickerInputElements.length; i++) {
                        var input = countryPickerInputElements[i];
                        var select = countryPickerInputElements[i].parentNode.parentNode.parentNode.querySelector('select');
                        if (input.value.trim() == "") select.selectedIndex = 0
                    }
                });
        </script>
    }
}

@hmrcLayout(
    pageTitle = Some(titleErr),
    isWelshTranslationAvailable = true, /* or false if your service has not been translated */
    serviceUrl = None,
    signOutUrl = Some(signOutUrl),
    phaseBanner = Some(standardBetaBanner(url = appConfig.betaFeedBackRegister(service))),
    additionalHeadBlock = Some(theHead),
    nonce = CSPNonce.get,
    serviceName = Some(messages("cds.banner.registration", longName)),
    accessibilityStatementUrl = Some(service.accessibilityUrl)
)(mainContent)
